<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feedback - SpeakEasy</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body class="feedback-page">
    <h1>Feedback for Your Speech</h1>

    <div class="main-container">
      <!-- Top Row: Transcription (Full Width) -->
      <div class="full-width-section">
        <div class="sub-section">
          <h2>Transcription:</h2>
          <p>{{ feedback.transcription }}</p>
        </div>
      </div>

      <!-- Middle Row: Three Columns -->
      <div class="three-column-container">
        <div class="column">
          <div class="sub-section">
            <h2>Fluency Stats:</h2>
            <ul>
              <li>WPM: {{ feedback.fluency.words_per_minute or "N/A" }}</li>
              <li>Filler Words: {{ feedback.fluency.filler_words }}</li>
              <li>
                Pauses: {{ "%.2f"|format(feedback.fluency.pauses) if
                feedback.fluency.pauses else "0.00" }}
              </li>
              <li>
                Vocab Score: {{
                "%.2f"|format(feedback.fluency.vocabulary_richness) }}
              </li>
            </ul>
          </div>

          <div class="sub-section">
            <h2>Detected Tone:</h2>
            <p><strong>{{ feedback.tone }}</strong></p>
          </div>
        </div>

        <div class="column">
          <div class="sub-section">
            <h2>Suggestions:</h2>
            <ul class="suggestions-list">
              {% for tip in feedback.feedback %}
              <li><strong>{{ tip.type }}:</strong> {{ tip.suggestion }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="column">
          <div class="sub-section">
            <h2>Audio Features:</h2>
            <ul>
              <li>
                Avg Pitch: {{ "%.1f"|format(feedback.audio.features.avg_pitch)
                if feedback.audio.features.avg_pitch else "N/A" }} Hz
              </li>
              <li>
                Pitch Var: {{ "%.1f"|format(feedback.audio.features.pitch_var)
                if feedback.audio.features.pitch_var else "N/A" }} Hz
              </li>
              <li>
                Loudness: {{
                "%.1f"|format(feedback.audio.features.avg_loudness_db) if
                feedback.audio.features.avg_loudness_db else "N/A" }} dB
              </li>
              <li>
                Speech Rate: {{
                "%.1f"|format(feedback.audio.features.speech_rate) if
                feedback.audio.features.speech_rate else "N/A" }}
              </li>
              <li>
                Pause Ratio: {{
                "%.2f"|format(feedback.audio.features.pause_ratio) if
                feedback.audio.features.pause_ratio else "N/A" }}
              </li>
              <li>
                Jitter: {{ "%.4f"|format(feedback.audio.features.jitter) if
                feedback.audio.features.jitter else "N/A" }}
              </li>
              <li>
                Shimmer: {{ "%.4f"|format(feedback.audio.features.shimmer) if
                feedback.audio.features.shimmer else "N/A" }}
              </li>
              <li>
                HNR: {{ "%.1f"|format(feedback.audio.features.hnr) if
                feedback.audio.features.hnr else "N/A" }} dB
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Bottom Row: Charts -->
      <div class="charts-section">
        <h2>Audio Analysis Graphs</h2>
        <div class="charts-container">
          <div class="chart-wrapper">
            <h3>Pitch Over Time</h3>
            <div class="chart-canvas-container">
              <canvas id="pitchChart"></canvas>
            </div>
          </div>
          <div class="chart-wrapper">
            <h3>Intensity Over Time</h3>
            <div class="chart-canvas-container">
              <canvas id="intensityChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const pitchData = {{ pitch_series | safe }};
      const intensityData = {{ intensity_series | safe }};

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2.2,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: { font: { size: 10 } }
          }
        },
        scales: {
          x: {
            title: { display: true, font: { size: 9 } },
            grid: { color: 'rgba(0,0,0,0.1)' },
            ticks: { font: { size: 8 }, maxTicksLimit: 6 }
          },
          y: {
            title: { display: true, font: { size: 9 } },
            grid: { color: 'rgba(0,0,0,0.1)' },
            ticks: { font: { size: 8 } }
          }
        }
      };

      if (pitchData && pitchData.length > 0) {
        const pitchCtx = document.getElementById('pitchChart').getContext('2d');
        new Chart(pitchCtx, {
          type: 'line',
          data: {
            labels: pitchData.map(p => p.time.toFixed(1)),
            datasets: [{
              label: 'Pitch (Hz)',
              data: pitchData.map(p => p.value),
              borderColor: '#05d0f9',
              backgroundColor: 'rgba(5, 208, 249, 0.1)',
              borderWidth: 1.5,
              fill: true,
              pointRadius: 0,
              tension: 0.1
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              x: { ...chartOptions.scales.x, title: { ...chartOptions.scales.x.title, text: 'Time (s)' }},
              y: { ...chartOptions.scales.y, title: { ...chartOptions.scales.y.title, text: 'Pitch (Hz)' }}
            }
          }
        });
      } else {
        document.getElementById('pitchChart').parentElement.innerHTML = '<p class="no-data">No pitch data available</p>';
      }

      if (intensityData && intensityData.length > 0) {
        const intensityCtx = document.getElementById('intensityChart').getContext('2d');
        new Chart(intensityCtx, {
          type: 'line',
          data: {
            labels: intensityData.map(i => i.time.toFixed(1)),
            datasets: [{
              label: 'Intensity (dB)',
              data: intensityData.map(i => i.value),
              borderColor: '#27ae60',
              backgroundColor: 'rgba(39, 174, 96, 0.1)',
              borderWidth: 1.5,
              fill: true,
              pointRadius: 0,
              tension: 0.1
            }]
          },
          options: {
            ...chartOptions,
            scales: {
              ...chartOptions.scales,
              x: { ...chartOptions.scales.x, title: { ...chartOptions.scales.x.title, text: 'Time (s)' }},
              y: { ...chartOptions.scales.y, title: { ...chartOptions.scales.y.title, text: 'Intensity (dB)' }}
            }
          }
        });
      } else {
        document.getElementById('intensityChart').parentElement.innerHTML = '<p class="no-data">No intensity data available</p>';
      }
    </script>
  </body>
</html>
